# BPNN
åå‘ä¼ æ’­ç¥ç»ç½‘ç»œ
## 1. å¼•ä¾‹
### 1.1 æ•°æ®è¯´æ˜
train.csvä¸­åŒ…æ‹¬çº¦1000æ¡çš„åŒ»ç–—è´¦å•æ•°æ®ï¼Œå…¶ä¸­
| age | sex | bmi | children | smoker | region | charges |
| :----: | :----: | :----: | :----: | :----: | :----: | :----: |
| 45 | female | 25.175 | 2 | no | northeast | 9095.06825 |
| 19 | male | 31.92 | 0 | yes | northwest | 33750.2918 |  
###
**age**ï¼šå¹´é¾„  
**sex**ï¼šæ€§åˆ«ï¼ŒåŒ…æ‹¬maleå’Œfemale  
**bmi**ï¼šèº«ä½“è´¨é‡æŒ‡æ•°  
**children**ï¼šå­©å­çš„æ•°é‡  
**somker**ï¼šæ˜¯å¦å¸çƒŸï¼Œyesè¡¨ç¤ºå¸çƒŸï¼Œnoè¡¨ç¤ºä¸å¸çƒŸ  
**region**ï¼šæ‰€å±åœ°åŒºï¼ŒåŒ…æ‹¬northeastï¼Œnorthwestï¼Œsoutheastå’Œsouthwestå››ä¸ªåœ°åŒº  
**charges**ï¼š åŒ»ç–—è´¹ç”¨  
åŸºäºä¸Šè¿°æœªåŠ ç²—å±æ€§ï¼ˆç‰¹å¾ï¼‰æ„å»ºæ¨¡å‹é¢„æµ‹chargeså±æ€§  

### 1.2 æ¨¡å‹è¦æ±‚
ä½¿ç”¨pandasè¯»å–æ•°æ®train.csvï¼Œè‡ªè¡Œå†³å®šæ•°æ®çš„é¢„å¤„ç†æ–¹å¼
ä½¿ç”¨numpyæ„å»ºå…¨è¿æ¥ç¥ç»ç½‘ç»œï¼Œè‡ªè¡Œå†³å®šæ¨¡å‹ç»“æ„
## 2. åˆ†æ
### 2.1 æ•°æ®é¢„å¤„ç†
å°†ç‰¹å¾ä¸­çš„æ–‡æœ¬ä¿¡æ¯è½¬åŒ–ä¸ºæ•°å­—ç¼–ç   
å¯¹æ•°æ®è¿›è¡Œå½’ä¸€åŒ–æˆ–æ ‡å‡†åŒ–ï¼Œé˜²æ­¢ç¥ç»ç½‘ç»œåç½®
### 2.2 ç½‘ç»œç»“æ„
è€ƒè™‘ä¸€ä¸ªç®€å•çš„ç½‘ç»œï¼Œæ‹¥æœ‰ä¸€å±‚éšè—å±‚ï¼Œéšè—å±‚èŠ‚ç‚¹æ•°ä¸º7ï¼Œè¾“å…¥èŠ‚ç‚¹6ä¸ªï¼Œè¾“å‡ºèŠ‚ç‚¹1ä¸ªã€‚
### 2.3 åå‘ä¼ æ’­ç®—æ³•
åå‘ä¼ æ’­ç®—æ³•(Back propagation)æ˜¯â€œè¯¯å·®åå‘ä¼ æ’­â€çš„ç®€ç§°ï¼Œæ˜¯é€‚åˆäºå¤šå±‚ç¥ç»å…ƒç½‘ç»œçš„ä¸€ç§å­¦ä¹ ç®—æ³•ï¼Œå®ƒå»ºç«‹åœ¨æ¢¯åº¦ä¸‹é™æ³•çš„åŸºç¡€ä¸Šã€‚æ¢¯åº¦ä¸‹é™æ³•æ˜¯è®­ç»ƒç¥ç»ç½‘ç»œçš„å¸¸ç”¨æ–¹æ³•ï¼Œè®¸å¤šçš„è®­ç»ƒæ–¹æ³•éƒ½æ˜¯åŸºäºæ¢¯åº¦ä¸‹é™æ³•æ”¹è‰¯å‡ºæ¥çš„ï¼Œå› æ­¤äº†è§£æ¢¯åº¦ä¸‹é™æ³•å¾ˆé‡è¦ã€‚æ¢¯åº¦ä¸‹é™æ³•é€šè¿‡è®¡ç®—æŸå¤±å‡½æ•°çš„æ¢¯åº¦ï¼Œå¹¶å°†è¿™ä¸ªæ¢¯åº¦åé¦ˆç»™æœ€ä¼˜åŒ–å‡½æ•°æ¥æ›´æ–°æƒé‡ä»¥æœ€å°åŒ–æŸå¤±å‡½æ•°ã€‚
BPç®—æ³•çš„å­¦ä¹ è¿‡ç¨‹ç”±æ­£å‘ä¼ æ’­è¿‡ç¨‹å’Œåå‘ä¼ æ’­è¿‡ç¨‹ç»„æˆã€‚  
å®ƒçš„åŸºæœ¬æ€æƒ³ä¸ºï¼š
(1)å…ˆè®¡ç®—æ¯ä¸€å±‚çš„çŠ¶æ€å’Œæ¿€æ´»å€¼ï¼Œç›´åˆ°æœ€åä¸€å±‚ï¼ˆå³ä¿¡å·æ˜¯å‰å‘ä¼ æ’­çš„ï¼‰ï¼›
(2)è®¡ç®—æ¯ä¸€å±‚çš„è¯¯å·®ï¼Œè¯¯å·®çš„è®¡ç®—è¿‡ç¨‹æ˜¯ä»æœ€åä¸€å±‚å‘å‰æ¨è¿›çš„ï¼ˆå³è¯¯å·®æ˜¯åå‘ä¼ æ’­çš„ï¼‰ï¼›
(3)è®¡ç®—æ¯ä¸ªç¥ç»å…ƒè¿æ¥æƒé‡çš„æ¢¯åº¦ï¼›
(4)æ ¹æ®æ¢¯åº¦ä¸‹é™æ³•åˆ™æ›´æ–°å‚æ•°ï¼ˆç›®æ ‡æ˜¯è¯¯å·®å˜å°ï¼‰ã€‚
è¿­ä»£ä»¥ä¸Šæ­¥éª¤ï¼Œç›´åˆ°æ»¡è¶³åœæ­¢å‡†åˆ™ï¼ˆæ¯”å¦‚ç›¸é‚»ä¸¤æ¬¡è¿­ä»£çš„è¯¯å·®çš„å·®åˆ«å¾ˆå°ï¼‰ã€‚
## 3. å®ç°ç»†èŠ‚  
### 3.1 ç¬¦å·ç³»ç»Ÿ
$x$ï¼šè¾“å…¥å‘é‡ï¼Œè¡¨ç¤ºè¾“å…¥æ•°æ®ï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€ä¸ªè¾“å…¥ç‰¹å¾  
$\hat y$ï¼šè¾“å‡ºå‘é‡ï¼Œè¡¨ç¤ºç½‘ç»œçš„é¢„æµ‹è¾“å‡º
$y$ï¼šç›®æ ‡å‘é‡ï¼Œè¡¨ç¤ºå®é™…çš„è¾“å‡ºå€¼
$W$ï¼šæƒé‡çŸ©é˜µï¼Œè¡¨ç¤ºè¿æ¥å±‚ä¸å±‚ä¹‹é—´çš„æƒé‡  
$ğ‘$ï¼šåç½®å‘é‡ï¼Œè¡¨ç¤ºæ¯ä¸€å±‚ç¥ç»å…ƒçš„åç½®é¡¹  
$\sigma$ï¼šæ¿€æ´»å‡½æ•°ï¼Œç”¨äºå¼•å…¥éçº¿æ€§ï¼Œå¦‚sigmoidå‡½æ•°ã€ReLUå‡½æ•°ç­‰  
$\eta$ï¼šå­¦ä¹ ç‡ï¼Œç”¨äºæ§åˆ¶æƒé‡æ›´æ–°æ­¥é•¿çš„è¶…å‚æ•°  
$z$ï¼šéšè—å±‚è¾“å‡ºå‘é‡ï¼Œè¡¨ç¤ºéšè—å±‚çš„è¾“å‡º  
$\delta$ï¼šè¯¯å·®é¡¹ï¼Œè¡¨ç¤ºè¯¯å·®çš„æ¢¯åº¦ï¼Œç”¨äºåå‘ä¼ æ’­è¿‡ç¨‹ä¸­  
$ğ‘$ï¼šæ¿€æ´»å€¼ï¼Œè¡¨ç¤ºç»è¿‡æ¿€æ´»å‡½æ•°å¤„ç†åçš„è¾“å‡º  
$W^{(l)}$ ï¼šç¬¬ $ğ‘™$å±‚çš„æƒé‡çŸ©é˜µ  
$b^{(l)}$ ï¼šç¬¬ $ğ‘™$å±‚çš„åç½®å‘é‡  
$\delta^{(l)}$ï¼šç¬¬ $ğ‘™$ å±‚çš„è¯¯å·®é¡¹  
$ğ¸$ï¼šæŸå¤±å‡½æ•° $ğ¸=\frac{1}{2}(\hat ğ‘¦âˆ’y)^2$  
### 3.2 åˆå§‹åŒ–ç¥ç»ç½‘ç»œ
```python
input_size = np.size(x, 1)  # è¾“å…¥ç‰¹å¾æ•°:6
hidden_size = 7  # éšè—å±‚å¤§å°
output_size = 1  # è¾“å‡ºå¤§å°ï¼ˆåŒ»ç–—è´¹ç”¨ï¼‰
```
```python
class NeuralNetwork:
    def __init__(self, input_size, hidden_size, output_size):
        self.input_size = input_size
        self.hidden_size = hidden_size
        self.output_size = output_size

        # Heåˆå§‹åŒ–æƒé‡
        self.weights_input_hidden = np.random.randn(input_size, hidden_size) * np.sqrt(2 / input_size)
        self.weights_hidden_output = np.random.randn(hidden_size, output_size) * np.sqrt(2 / hidden_size)

        # åˆå§‹åŒ–åç½®ä¸ºé›¶
        self.bias_input_hidden = np.zeros((1, hidden_size))
        self.bias_hidden_output = np.zeros((1, output_size))
```
### 3.3 å‰å‘ä¼ æ’­
```python
    def forward(self, x):
        # å‰å‘ä¼ æ’­
        self.hidden_input = np.dot(x, self.weights_input_hidden) + self.bias_input_hidden
        self.hidden_output = sigmoid(self.hidden_input)
        self.output = np.dot(self.hidden_output, self.weights_hidden_output) + self.bias_hidden_output
        return self.output
```
éšè—å±‚è¾“å‡ºï¼š $ğ‘§=\delta(ğ‘Š^{(1)}ğ‘¥+ğ‘^{(1)})$  
è¾“å‡ºå±‚è¾“å‡ºï¼š $ğ‘¦=ğ‘Š^{(2)}ğ‘§+ğ‘^{(2)}$  
### 3.4 åå‘ä¼ æ’­
```python
    def backward(self, x, y, output, learning_rate, i):
        # è®¡ç®—è¾“å‡ºå±‚çš„è¯¯å·®(åç½®æ¢¯åº¦)
        output_error = output - y  # loss = 0.5 * mse_loss(self.output[i, :], y[i, :].T)
        # è®¡ç®—è¾“å‡ºå±‚æƒé‡çš„æ¢¯åº¦
        output_delta = np.atleast_2d(output_error * self.hidden_output[i, :]).T  # 7*1
        # è®¡ç®—éšè—å±‚çš„è¯¯å·®(åç½®æ¢¯åº¦)
        hidden_error = np.dot(self.weights_hidden_output, np.atleast_2d(output_error)).T * sigmoid_derivative(
            self.hidden_input[i, :])  # 1*7
        # è®¡ç®—éšè—å±‚æƒé‡çš„æ¢¯åº¦
        hidden_delta = hidden_error * np.atleast_2d(x).T  # 6*7 hidden_delta = np.dot(np.atleast_2d(x[i, :]).T, hidden_error)

        # æ›´æ–°æƒé‡å’Œåç½®
        self.weights_hidden_output -= learning_rate * output_delta  # 7*1
        self.bias_hidden_output -= learning_rate * output_error  # 1*1
        self.weights_input_hidden -= learning_rate * hidden_delta  # 6*7
        self.bias_input_hidden -= learning_rate * hidden_error  # 1*7
```
è¯¯å·®åˆ†æï¼š  
è¾“å‡ºå±‚è¯¯å·®ï¼š å³æŸå¤±å‡½æ•°çš„æ¢¯åº¦ $\nabla E=ğ›¿^{(2)}=\hat ğ‘¦âˆ’y$  
éšè—å±‚è¯¯å·®ï¼š $ğ›¿^{(1)}=(ğ‘Š^{(2)})^âŠ¤ğ›¿^{(2)}âŠ™ğœ^â€²(ğ‘¥)$  
æƒé‡æ›´æ–°ï¼š  
è¾“å‡ºå±‚æƒé‡æ›´æ–°ï¼š $ğ‘Š^{(2)}\leftarrow ğ‘Š^{(2)}âˆ’ğœ‚ğ›¿^{(2)}ğ‘§^âŠ¤$  
è¾“å‡ºå±‚åç½®æ›´æ–°ï¼š $b^{(2)}\leftarrow b^{(2)}-ğœ‚ğ›¿^{(2)}$  
éšè—å±‚æƒé‡æ›´æ–°ï¼š $ğ‘Š^{(1)}\leftarrow ğ‘Š^{(1)}-ğœ‚ğ›¿^{(1)}ğ‘¥^âŠ¤$  
éšè—å±‚åç½®æ›´æ–°ï¼š $b^{(1)}\leftarrow b^{(1)}-ğœ‚ğ›¿^{(1)}$  
